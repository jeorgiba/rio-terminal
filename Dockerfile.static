# Simplified Dockerfile for static site deployment
# 
# Credits: Based on Rio Terminal by Raphael Amorim
# Original project: https://github.com/raphamorim/rio
# Author: Raphael Amorim <rapha850@gmail.com>
# License: MIT

FROM rust:1.80-slim as builder

# Install system dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    curl \
    build-essential \
    git \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install WASM tools
RUN rustup target add wasm32-unknown-unknown

# Download pre-built wasm-bindgen instead of compiling
RUN wget https://github.com/rustwasm/wasm-bindgen/releases/download/0.2.88/wasm-bindgen-0.2.88-x86_64-unknown-linux-musl.tar.gz \
    && tar -xzf wasm-bindgen-0.2.88-x86_64-unknown-linux-musl.tar.gz \
    && mv wasm-bindgen-0.2.88-x86_64-unknown-linux-musl/wasm-bindgen* /usr/local/bin/ \
    && rm -rf wasm-bindgen-0.2.88-*

# Set working directory
WORKDIR /app

# Copy the entire project
COPY . .

# Build the WASM frontend
WORKDIR /app/frontends/wasm
RUN cargo build --target wasm32-unknown-unknown --release --lib

# Generate JavaScript bindings
RUN wasm-bindgen ../../target/wasm32-unknown-unknown/release/rioterm_wasm.wasm \
    --out-dir . \
    --target web \
    --no-typescript

# Production stage - serve static files
FROM nginx:alpine

# Copy built WASM files and HTML
COPY --from=builder /app/frontends/wasm /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
